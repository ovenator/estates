import json

import scrapy
from scrapy import FormRequest

from estates.items import Estate, Coords

payload = {
    'offerType': 'prodej',
    'estateType': 'byt,dum',
    'ownership': 'osobni',
    'surfaceFrom': '1',
    'boundary': '[[[{"lat":50.1029963,"lng":14.2244355},{"lat":50.1003919,"lng":14.2265265},{"lat":50.1034693,"lng":14.2498381},{"lat":50.0993837,"lng":14.2583441},{"lat":50.097063,"lng":14.2544382},{"lat":50.0962906,"lng":14.2609996},{"lat":50.0870952,"lng":14.2610944},{"lat":50.087619,"lng":14.273347},{"lat":50.0810719,"lng":14.2752539},{"lat":50.0814296,"lng":14.2845716},{"lat":50.0782609,"lng":14.2850094},{"lat":50.0771366,"lng":14.2893735},{"lat":50.073178,"lng":14.2901916},{"lat":50.0743046,"lng":14.2824327},{"lat":50.072986,"lng":14.2772618},{"lat":50.0709193,"lng":14.2785556},{"lat":50.0730871,"lng":14.2753003},{"lat":50.0715166,"lng":14.2580521},{"lat":50.0644236,"lng":14.2587145},{"lat":50.0622236,"lng":14.2475584},{"lat":50.0583091,"lng":14.2480852},{"lat":50.0544227,"lng":14.2572299},{"lat":50.0555304,"lng":14.262304},{"lat":50.0523325,"lng":14.2643067},{"lat":50.0543186,"lng":14.2716323},{"lat":50.0506112,"lng":14.2726358},{"lat":50.0486908,"lng":14.2681736},{"lat":50.0469324,"lng":14.2710433},{"lat":50.040097,"lng":14.2700997},{"lat":50.0279596,"lng":14.2872209},{"lat":50.0235558,"lng":14.2975722},{"lat":50.0235953,"lng":14.3158709},{"lat":50.006978,"lng":14.3114577},{"lat":50.0118141,"lng":14.3007933},{"lat":50.0043801,"lng":14.30053},{"lat":50.0022104,"lng":14.2948377},{"lat":49.993838,"lng":14.3101029},{"lat":49.9947829,"lng":14.3139615},{"lat":49.9888928,"lng":14.3181009},{"lat":49.9938483,"lng":14.3349813},{"lat":49.9906305,"lng":14.3427557},{"lat":49.9886648,"lng":14.3353153},{"lat":49.9807517,"lng":14.3395903},{"lat":49.9718584,"lng":14.3268139},{"lat":49.9747107,"lng":14.3461789},{"lat":49.9676279,"lng":14.344916},{"lat":49.9648505,"lng":14.3292319},{"lat":49.9572087,"lng":14.3254392},{"lat":49.9475842,"lng":14.3428774},{"lat":49.9474546,"lng":14.3603929},{"lat":49.9513236,"lng":14.3683756},{"lat":49.9466207,"lng":14.3768119},{"lat":49.9497837,"lng":14.3879707},{"lat":49.9451745,"lng":14.3890496},{"lat":49.9419006,"lng":14.395562},{"lat":49.9538976,"lng":14.3942296},{"lat":49.9706693,"lng":14.4006472},{"lat":49.9635636,"lng":14.4194183},{"lat":49.9681197,"lng":14.4386195},{"lat":49.9738632,"lng":14.4445941},{"lat":49.9707711,"lng":14.4622402},{"lat":49.9810366,"lng":14.4663038},{"lat":49.9804035,"lng":14.4739923},{"lat":49.9837523,"lng":14.473704},{"lat":49.985687,"lng":14.486985},{"lat":49.992419,"lng":14.4839334},{"lat":49.9974771,"lng":14.5072536},{"lat":49.9921388,"lng":14.5081846},{"lat":49.992583,"lng":14.5137466},{"lat":50.0007153,"lng":14.5300192},{"lat":50.0077216,"lng":14.520994},{"lat":50.0108381,"lng":14.5274725},{"lat":50.0079867,"lng":14.5508521},{"lat":50.0121564,"lng":14.5542318},{"lat":50.0115863,"lng":14.5627521},{"lat":50.0073516,"lng":14.5683172},{"lat":50.0163634,"lng":14.582393},{"lat":50.010951,"lng":14.5817136},{"lat":50.0100508,"lng":14.5944084},{"lat":50.007143,"lng":14.5949721},{"lat":50.0094315,"lng":14.6022636},{"lat":50.0019258,"lng":14.6039007},{"lat":50.002937,"lng":14.6078305},{"lat":49.9986363,"lng":14.6103406},{"lat":49.9944411,"lng":14.6401518},{"lat":49.9987546,"lng":14.6469229},{"lat":50.0057827,"lng":14.6382891},{"lat":50.0047342,"lng":14.6454958},{"lat":50.0087938,"lng":14.6498044},{"lat":50.0043495,"lng":14.6577854},{"lat":50.0084011,"lng":14.6626193},{"lat":50.0127833,"lng":14.6615855},{"lat":50.0134346,"lng":14.6685483},{"lat":50.0188407,"lng":14.669537},{"lat":50.0309551,"lng":14.6561272},{"lat":50.0378173,"lng":14.6569571},{"lat":50.0385277,"lng":14.6668511},{"lat":50.0492542,"lng":14.6538674},{"lat":50.0421831,"lng":14.6440386},{"lat":50.0484131,"lng":14.6402196},{"lat":50.0568947,"lng":14.6401916},{"lat":50.0720182,"lng":14.6908607},{"lat":50.0721289,"lng":14.6999919},{"lat":50.0870194,"lng":14.7067867},{"lat":50.0917426,"lng":14.7039175},{"lat":50.0963003,"lng":14.6886937},{"lat":50.1006277,"lng":14.6903288},{"lat":50.1026521,"lng":14.665884},{"lat":50.1065009,"lng":14.6574355},{"lat":50.1226041,"lng":14.6591154},{"lat":50.1239183,"lng":14.6352008},{"lat":50.1299032,"lng":14.6322995},{"lat":50.1271149,"lng":14.6086335},{"lat":50.129523,"lng":14.6005164},{"lat":50.1452435,"lng":14.5877286},{"lat":50.1541328,"lng":14.5990028},{"lat":50.1501702,"lng":14.5632297},{"lat":50.1615751,"lng":14.5609936},{"lat":50.1661221,"lng":14.5505391},{"lat":50.161565,"lng":14.5342354},{"lat":50.1661902,"lng":14.5305116},{"lat":50.1771831,"lng":14.5324832},{"lat":50.1774301,"lng":14.5268551},{"lat":50.1714361,"lng":14.5069039},{"lat":50.1722942,"lng":14.4795218},{"lat":50.1698783,"lng":14.4801495},{"lat":50.1695438,"lng":14.4669127},{"lat":50.159923,"lng":14.4641231},{"lat":50.1576674,"lng":14.4281375},{"lat":50.1535113,"lng":14.4289771},{"lat":50.1529649,"lng":14.4200136},{"lat":50.1498332,"lng":14.4225022},{"lat":50.1479062,"lng":14.3999734},{"lat":50.1433746,"lng":14.3991472},{"lat":50.141429,"lng":14.3949016},{"lat":50.1469262,"lng":14.3848779},{"lat":50.1480311,"lng":14.3657001},{"lat":50.137526,"lng":14.3541236},{"lat":50.1296478,"lng":14.3574439},{"lat":50.1295213,"lng":14.3600421},{"lat":50.1246523,"lng":14.3556407},{"lat":50.1160189,"lng":14.3607835},{"lat":50.1152415,"lng":14.3206068},{"lat":50.1229456,"lng":14.3156962},{"lat":50.1286167,"lng":14.3158782},{"lat":50.1300768,"lng":14.3024335},{"lat":50.1247846,"lng":14.2946854},{"lat":50.1205942,"lng":14.2971713},{"lat":50.1162211,"lng":14.2883495},{"lat":50.1190811,"lng":14.2788382},{"lat":50.1107913,"lng":14.2500356},{"lat":50.1117993,"lng":14.2388054},{"lat":50.1072816,"lng":14.2393227},{"lat":50.1029963,"lng":14.2244355}]]]',
    'hasDrawnBoundary': 'true',
    'locationInput': 'Praha, ÄŒesko'
}


class EstateSpider(scrapy.Spider):
    name = 'bezrealitky'
    allowed_domains = ['bezrealitky.cz']

    def start_requests(self):
        yield FormRequest('https://www.bezrealitky.cz/api/record/markers', method='POST', formdata=payload)

    def parse(self, response):
        res_obj = json.loads(response.text)
        for estate in res_obj:
            try:
                ext_id = estate['id']
                offer = estate['advertEstateOffer'][0]
                gps = json.loads(offer['gps'])
                coords = Coords(
                    lon = gps['lng'],
                    lat = gps['lat'],
                )
                price = offer['price']

                area = offer['surface']

                yield Estate(
                    ext_key = ext_id,
                    orig_address = None,
                    coords_lon = coords['lon'],
                    coords_lat = coords['lat'],
                    url = f'https://www.bezrealitky.cz/nemovitosti-byty-domy/{estate["uri"]}',
                    price = price,
                    area = area,
                    pictures = []
                )
            except Exception as e:
                continue



